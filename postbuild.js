const fs = require('fs');
const path = require('path');

console.log('ğŸ” Iniciando verificaciÃ³n post-build...');
console.log('ğŸ“‚ Directorio actual:', __dirname);

// Posibles rutas donde puede estar el index.html
const possiblePaths = [
  path.join(__dirname, 'dist/coreui-free-angular-admin-template/browser/index.html'),
  path.join(__dirname, 'dist/coreui-free-angular-admin-template/index.html'),
  path.join(__dirname, 'dist/browser/index.html'),
  path.join(__dirname, 'dist/index.html')
];

let indexFound = false;
let foundPath = '';
let distDir = '';

// Verificar cada posible ruta
for (const indexPath of possiblePaths) {
  console.log('ğŸ” Verificando:', indexPath);
  if (fs.existsSync(indexPath)) {
    console.log('âœ… index.html encontrado en:', indexPath);
    indexFound = true;
    foundPath = indexPath;
    distDir = path.dirname(indexPath);
    break;
  }
}

if (!indexFound) {
  console.error('âŒ No se encontrÃ³ index.html en ninguna de las rutas esperadas');
  
  // Listar contenido del directorio dist para debug
  const distPath = path.join(__dirname, 'dist');
  if (fs.existsSync(distPath)) {
    console.log('ğŸ“ Contenido de dist:');
    
    function listDirectory(dirPath, prefix = '') {
      try {
        const items = fs.readdirSync(dirPath, { withFileTypes: true });
        items.forEach(item => {
          const itemPath = path.join(dirPath, item.name);
          console.log(`${prefix}${item.isDirectory() ? 'ğŸ“' : 'ğŸ“„'} ${item.name}`);
          
          if (item.isDirectory() && prefix.length < 8) { // Limitar la profundidad
            listDirectory(itemPath, prefix + '  ');
          }
        });
      } catch (err) {
        console.log(`${prefix}âŒ Error leyendo directorio: ${err.message}`);
      }
    }
    
    listDirectory(distPath);
  } else {
    console.log('âŒ El directorio dist no existe');
  }
  
  process.exit(1);
}

// Verificar favicon
const faviconPath = path.join(distDir, 'favicon.ico');
console.log('ğŸ” Verificando favicon en:', faviconPath);
if (fs.existsSync(faviconPath)) {
  console.log('âœ… favicon.ico encontrado');
} else {
  console.log('âš ï¸ favicon.ico no encontrado, copiando desde diferentes fuentes...');
  
  // Intentar copiar desde diferentes ubicaciones
  const sourceFaviconPaths = [
    path.join(__dirname, 'src/assets/favicon.ico'),
    path.join(__dirname, 'public/favicon.ico'),
    path.join(__dirname, 'favicon.ico')
  ];
  
  let faviconCopied = false;
  for (const sourceFavicon of sourceFaviconPaths) {
    if (fs.existsSync(sourceFavicon)) {
      fs.copyFileSync(sourceFavicon, faviconPath);
      console.log(`âœ… favicon.ico copiado desde ${sourceFavicon}`);
      faviconCopied = true;
      break;
    }
  }
  
  if (!faviconCopied) {
    console.log('âš ï¸ No se encontrÃ³ favicon.ico en ninguna ubicaciÃ³n, creando uno por defecto...');
    // Crear un favicon bÃ¡sico
    const defaultFavicon = Buffer.from([
      0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x10, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x28, 0x01,
      0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x20, 0x00,
      0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    ]);
    fs.writeFileSync(faviconPath, defaultFavicon);
    console.log('âœ… favicon.ico por defecto creado exitosamente');
  }
}

// Verificar _redirects para hash routing
const redirectsPath = path.join(distDir, '_redirects');
console.log('ğŸ” Verificando _redirects en:', redirectsPath);
if (!fs.existsSync(redirectsPath)) {
  console.log('ğŸ“ Creando archivo _redirects para hash routing...');
  fs.writeFileSync(redirectsPath, '/*    /index.html   200\n');
  console.log('âœ… _redirects creado exitosamente');
} else {
  console.log('âœ… _redirects ya existe');
}

// Verificar assets directory
const assetsPath = path.join(distDir, 'assets');
console.log('ğŸ” Verificando directorio assets en:', assetsPath);
if (fs.existsSync(assetsPath)) {
  console.log('âœ… Directorio assets encontrado');
  
  // Verificar favicon en assets tambiÃ©n
  const assetsFaviconPath = path.join(assetsPath, 'favicon.ico');
  if (fs.existsSync(assetsFaviconPath)) {
    console.log('âœ… favicon.ico encontrado en assets');
  } else {
    console.log('âš ï¸ favicon.ico no encontrado en assets, copiando...');
    const sourceFavicon = path.join(__dirname, 'src/assets/favicon.ico');
    if (fs.existsSync(sourceFavicon)) {
      fs.copyFileSync(sourceFavicon, assetsFaviconPath);
      console.log('âœ… favicon.ico copiado a assets exitosamente');
    }
  }
} else {
  console.log('âš ï¸ Directorio assets no encontrado');
}

console.log('âœ… Build completado exitosamente');
console.log('ğŸ“ Archivo index.html encontrado en:', foundPath);
console.log('ğŸ“ Directorio de distribuciÃ³n:', distDir);

// Verificar archivos crÃ­ticos
console.log('\nğŸ” Verificando archivos crÃ­ticos:');
const criticalFiles = [
  'index.html',
  'favicon.ico',
  'assets'
];

criticalFiles.forEach(file => {
  const filePath = path.join(distDir, file);
  if (fs.existsSync(filePath)) {
    console.log(`âœ… ${file} - OK`);
  } else {
    console.log(`âŒ ${file} - FALTANTE`);
  }
});

// Verificar que los archivos JS y CSS existen
console.log('\nğŸ” Verificando archivos generados:');
const jsFiles = fs.readdirSync(distDir).filter(file => file.endsWith('.js'));
const cssFiles = fs.readdirSync(distDir).filter(file => file.endsWith('.css'));

console.log(`ğŸ“„ Archivos JS encontrados: ${jsFiles.length}`);
jsFiles.forEach(file => console.log(`  - ${file}`));

console.log(`ğŸ“„ Archivos CSS encontrados: ${cssFiles.length}`);
cssFiles.forEach(file => console.log(`  - ${file}`));

console.log('\nâœ… VerificaciÃ³n post-build completada');
